<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="title">Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" data-th-href="@{/css/output.css}" />
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* Ensure the main chart canvas takes 100% width */
      /* Constrain the chart container width so it doesn’t stretch too far on large screens */
      /* .chart-container {
        max-width: 800px; 
        margin: 0 auto;
      } */

      /* Fixed styles for axis fonts */
      .chart-axis-title {
        font-size: 14px !important;
      }
      .chart-tick-font {
        font-size: 12px !important;
      }
      /* Fixed indicator styles */
      .indicator {
        width: 100%;
        text-align: left;
      }
      .indicator .label {
        font-size: 1rem;
      }
      .indicator .value {
        font-size: 1.25rem;
      }
      #investmentValueChart {
        width: 100% !important;
      }

      @media (min-width: 768px) {
  /* For medium screens: left 35% and right 65% */
  .left-md {
    width: 40% !important;
  }
  .right-md {
    width: 60% !important;
  }
}

@media (min-width: 1024px) {
  /* For large screens: left 30% and right 70% */
  .left-lg {
    width: 30% !important;
  }
  .right-lg {
    width: 70% !important;
  }
}
    </style>
  </head>
  <body class="dark:bg-dark-background dark:text-dark-primary text-light-primary bg-light-background">
    <!-- if user is logged in then this navbar -->
    <div th:if="${loggedInUser}">
      <div data-th-replace="~{user/user_navbar :: user-navbar}"></div>
    </div>

    <div id="content">
      <div class="grid grid-cols-12 px-2">
        <div class="xl:col-span-0"></div>
        <div class="col-span-12">
          <!-- Main Dashboard Content -->
          <div class="mt-20">

            <!-- Top Section: Line Chart -->
            
              <div class="flex flex-col md:flex-row gap-4 mb-4">
                <!-- Card 1: Indicators -->
                <div class="bg-light-background_secondary dark:bg-dark-background_secondary p-4 rounded-lg shadow w-full left-lg left-md flex flex-col justify-center items-start gap-2">
                  <div class="indicator mb-2">
                    <p class="label text-light-primary dark:text-dark-primary">Total Invested</p>
                    <p class="value" th:text="${totalInvested}">₹0</p>
                  </div>
                  <div class="indicator mb-2">
                    <p class="label text-light-primary dark:text-dark-primary">Total Value</p>
                    <p class="value" th:text="${currentValue}">₹0</p>
                  </div>
                  <div class="indicator">
                    <p class="label text-light-primary dark:text-dark-primary">Net Returns</p>
                    <p class="value" th:text="${netReturns}">0%</p>
                  </div>
                </div>
                <!-- Card 2: Graph -->
                <div class="bg-light-background_secondary dark:bg-dark-background_secondary p-1 rounded-lg shadow w-full right-lg right-md">
                  <canvas id="investmentValueChart" class="w-full h-48"></canvas>
                </div>
              </div>
            




            <!-- Middle Section: Top 3 Portfolio Cards -->
            <div
              class="w-full grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"
            >
              <div
                th:each="portfolio : ${topPortfolios}"
                class="bg-light-background_secondary dark:bg-dark-background_secondary p-3 rounded-lg shadow"
              >
                <div class="flex flex-row justify-between gap-2 mb-4">
                  <div class="pl-4">

                    <h3
                      class="text-2xl font-bold text-light-primary dark:text-dark-primary"
                      th:text="${portfolio.name}"
                    ></h3>
                    <p
                      class="text-sm text-light-secondary dark:text-dark-secondary"
                      th:text="${portfolio.description}"
                    ></p>
                  </div>
                  <div class="pr-6">

                    <p class="text-sm text-gray-600 dark:text-gray-300 mb-1">
                      Invested : ₹<span class="ml-0.5"
                        th:text="${portfolio.totalValue}"
                      ></span>
                    </p>
                    <p class="text-sm text-gray-600 dark:text-gray-300">
                      Current : ₹<span class="ml-0.5" th:text="${portfolio.totalValue}"></span>
                    </p>
                  </div>
                  <!-- <p
                    class="text-sm font-semibold"
                    th:class="${portfolio.totalValue - portfolio.totalInvested < 0 ? 'text-red-500' : 'text-green-500'}"
                  >
                    Return:
                    <span
                      th:text="${T(java.lang.String).format('%.2f', ((portfolio.totalValue - portfolio.totalInvested) * 100 / portfolio.totalInvested))}"
                    ></span
                    >%
                  </p> -->
                </div>
                <div class="w-full h-36">
                  <canvas
                    th:attr="id='miniChart' + ${portfolio.id}"
                    class="w-full h-full"
                  ></canvas>
                </div>
                <!-- <div class="mt-2 text-center">
                  <a
                    th:href="@{'/portfolios/' + ${portfolio.id}}"
                    class="px-4 py-2 rounded bg-blue-700 text-white text-sm hover:bg-blue-800 transition-colors duration-300"
                  >
                    View Details
                  </a>
                </div> -->
              </div>
            </div>

            <!-- Bottom Section: Insight Cards -->
            <div class="w-full grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
              <!-- Donut Chart for Portfolio Distribution -->
              <div class="bg-light-background_secondary dark:bg-dark-background_secondary p-4 rounded-lg shadow">
                <h3 class="text-xl font-bold text-light-primary dark:text-dark-primary mb-2 text-center">
                  Portfolio Distribution
                </h3>
                <div class="flex justify-center">
                  <!-- Fixed size canvas -->
                  <canvas id="portfolioDonutChart" width="128" height="128"></canvas>
                </div>
                <div class="text-center mt-2">
                  <a href="/portfolios" class="text-blue-600 dark:text-blue-400 hover:underline">
                    View All Portfolios
                  </a>
                </div>
              </div>
              <!-- Donut Chart for Stock Distribution -->
              <div class="bg-light-background_secondary dark:bg-dark-background_secondary p-4 rounded-lg shadow">
                <h3 class="text-xl font-bold text-light-primary dark:text-dark-primary mb-2 text-center">
                  Stock Distribution
                </h3>
                <div class="flex justify-center">
                  <canvas id="stockDonutChart" width="160" height="160"></canvas>
                </div>
                <div class="text-center mt-2">
                  <a href="/stocks" class="text-blue-600 dark:text-blue-400 hover:underline">
                    View All Stocks
                  </a>
                </div>
              </div>
              <!-- Donut Chart for Total Profit/Loss -->
              <div class="bg-light-background_secondary dark:bg-dark-background_secondary p-4 rounded-lg shadow">
                <h3 class="text-xl font-bold text-light-primary dark:text-dark-primary mb-2 text-center">
                  Total Profit/Loss
                </h3>
                <div class="flex justify-center">
                  <canvas id="profitLossDonutChart" width="128" height="128"></canvas>
                </div>
                <div class="text-center mt-2">
                  <a href="/transactions" class="text-blue-600 dark:text-blue-400 hover:underline">
                    View Transactions
                  </a>
                </div>
              </div>
            </div>
            
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <footer th:replace="~{shared/footer :: footer}"></footer>

    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.5.2/dist/flowbite.min.js"></script>

    <script data-th-src="@{'/js/script.js'}"></script>

    <!-- Chart.js Scripts for Graphs -->
    <script th:inline="javascript">
      /*<![CDATA[*/
      // First, register a custom plugin to draw an inner legend inside the chart area.
      Chart.register({
        id: "innerLegend",
        afterDraw: function (chart) {
          const ctx = chart.ctx;
          const datasets = chart.data.datasets;
          const chartArea = chart.chartArea;
          // Set starting coordinates inside the chart area (adjust as needed)
          let x = chartArea.left + 10;
          let y = chartArea.top + 20;
          ctx.save();
          // ctx.font = "12px sans-serif";
          ctx.fillStyle = "black";
          datasets.forEach((dataset, i) => {
            // Draw the line symbol with dash pattern
            ctx.beginPath();
            // ctx.setLineDash([5, 5]);
            ctx.strokeStyle = dataset.borderColor;
            ctx.moveTo(x, y + i * 20);
            ctx.lineTo(x + 30, y + i * 20);
            ctx.stroke();
            // ctx.setLineDash([]); // reset dash
            // Draw the label text next to the symbol
            ctx.fillText(dataset.label, x + 40, y + i * 20 + 4);
          });
          ctx.restore();
        },
      });

      // Line Chart for Total Investment vs. Total Value Over Time
      console.log("Graph Data: ", /*[[${graphData}]]*/ {});
      const lineCtx = document
        .getElementById("investmentValueChart")
        .getContext("2d");
      // Replace the following with your dynamic data or bind via Thymeleaf (e.g., [[${graphData}]])
      console.log("Canvas Found:", lineCtx);
      var graphData = /*[[${graphData}]]*/ {};

      new Chart(lineCtx, {
        type: "line",
        data: {
          labels: graphData.dates,
          datasets: [
            {
              label: "Total Invested",
              data: graphData.totalInvestments,
              borderColor: "blue",
              fill: false,
              tension: 0.3,
            },
            {
              label: "Total Value",
              data: graphData.totalValues,
              borderColor: "green",
              fill: false,
              tension: 0.3,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              position: "bottom",
              title: {
                display: false,
                text: "Date",
                font: {
                  size: 14,
                },
              },
              ticks: {
                font: {
                  size: 12,
                },
              },
            },
            y: {
              position: "left",
              title: {
                display: true,
                text: "Amount (₹)",
                font: {
                  size: 14,
                },
              },
              ticks: {
                font: {
                  size: 12,
                },
              },
            },
          },
          plugins: {
            // Optionally, you can force the legend font size as well:
            legend: {
              display: false,
              labels: {
                font: {
                  size: 12,
                },
              },
              layout: {
                padding: -30, // Adjust negative padding to move legend into chart area
              },
            },
          },
        },
      });

      // Donut Chart for Portfolio Distribution
      const portfolioDonutCtx = document.getElementById('portfolioDonutChart').getContext('2d');
    new Chart(portfolioDonutCtx, {
      type: 'doughnut',
      data: {
        labels: ['A', 'B', 'C'],
        datasets: [{
          data: [40, 35, 25],
          backgroundColor: ['#4CAF50', '#2196F3', '#FFC107']
        }]
      },
      options: {
        responsive: false, // Disable responsiveness to use fixed canvas size
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        }
      }
    });

    // Stock Distribution Donut Chart
    const stockDonutCtx = document.getElementById('stockDonutChart').getContext('2d');
    new Chart(stockDonutCtx, {
      type: 'doughnut',
      data: {
        labels: ['X', 'Y', 'Z'],
        datasets: [{
          data: [50, 30, 20],
          backgroundColor: ['#FF5722', '#9C27B0', '#03A9F4']
        }]
      },
      options: {
        responsive: false,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        }
      }
    });

    // Total Profit/Loss Donut Chart
    const profitLossDonutCtx = document.getElementById('profitLossDonutChart').getContext('2d');
    new Chart(profitLossDonutCtx, {
      type: 'doughnut',
      data: {
        labels: ['Profit', 'Loss'],
        datasets: [{
          data: [70, 30],
          backgroundColor: ['#4CAF50', '#F44336']
        }]
      },
      options: {
        responsive: false,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        }
      }
    });

      // Mini Charts for Portfolio Cards can be initialized similarly using each card's canvas element,
      // which is identified by an id like "miniChart{portfolio.id}"
    </script>

    <!-- Inline script to initialize mini charts for each portfolio -->
<script th:each="portfolio : ${topPortfolios}" th:inline="javascript">
  // Set global default (optional)
  Chart.defaults.plugins.legend.display = false;
  /*<![CDATA[*/
  // Disable legend globally for all charts
  Chart.defaults.plugins.legend.display = false;
    // Retrieve the mini chart data for the current portfolio.
    var miniData = /*[[${portfolio.miniChartData}]]*/ {};
    // Get the canvas element using the portfolio id.
    var miniCanvas = document.getElementById("miniChart" + /*[[${portfolio.id}]]*/ "");
    if (miniCanvas && miniData && miniData.dates) {
      new Chart(miniCanvas.getContext("2d"), {
        type: 'line',
        data: {
          labels: miniData.dates,
          datasets: [
            {
              label: 'Total Invested',
              data: miniData.totalInvestments,
              borderColor: 'blue',
              fill: false,
              tension: 0.3
            },
            {
              label: 'Total Value',
              data: miniData.totalValues,
              borderColor: 'green',
              fill: false,
              tension: 0.3
            }
          ]
        },
        
        options: {
          responsive: true,
          maintainAspectRatio: false,
          // Hide the scales for a compact mini chart
          scales: {
            x: { display: true },
            y: { display: true }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }
  /*]]>*/
  </script>
  

  </body>
</html>
